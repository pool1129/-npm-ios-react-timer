name: ios-react-time-picker update 

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

jobs:
  release:
    permissions:
      # 저장소의 컨텐츠에 대한 읽기 권한 부여
      contents: write
      # 풀 리퀘스트에 관련된 작업에 쓰기 권한 부여
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      # refs/tags/vX.Y.Z 형식의 태그에서 X.Y.Z 버전 번호만 출력해 version 변수에 저장
      - name: get semantic version
        id: semver
        run: echo "::set-output name=version::${GITHUB_REF#refs/tags/v}"
      - uses: actions/checkout@v4
        with:
          ref: v${{ steps.semver.outputs.version }}

      # npm 배포를 위한 Node 설치
      - uses: actions/setup-node@v3.6.0
        with:
          node-version: "20.3.0"

      # 인증토큰 .npmrc 파일에 설정
      - name: setup npm auth
        run: echo "//registry.npmjs.org/:_authToken=${NPM_AUTH_TOKEN}" > ~/.npmrc
        env:
          NPM_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}

      # 깃허브 봇으로 package.json 파일 version 을 git tag 버전으로 업데이트
      - name: update package version
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git tag -d ${{ github.ref_name }} || true
          git push origin :refs/tags/${{ github.ref_name }} || true
          npm version ${{ steps.semver.outputs.version }}

      # 업데이트 버전 commit / push
      - name: commit updated package version
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "[chore] update package version"
          branch: main

      # git tab 신규 생성
      - name: update git tag
        run: |
          git tag -f ${{ github.ref_name }}
          git push --force origin ${{ github.ref_name }}

      # npm의 access token을 사용해 배포
      - run: npm publish
        env:
          NPM_AUTH_TOKEN: ${{ secrets.NPM_AUTH_TOKEN }}
